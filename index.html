<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®ºæ–‡é€‰æ‹©ç³»ç»Ÿ - å¤šè®¾å¤‡åŒæ­¥ç‰ˆ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            padding: 20px;
            color: #333;
        }
        
        .container {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            gap: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .user-table-container, .paper-list-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            flex: 1;
        }
        
        .section-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .paper-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            cursor: grab;
            transition: all 0.2s;
            border-left: 4px solid #3498db;
        }
        
        .paper-item:hover {
            background-color: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .paper-item.dragging {
            opacity: 0.5;
        }
        
        .paper-item.assigned {
            background-color: #e8f5e9;
            border-left-color: #4caf50;
        }
        
        .drop-zone {
            min-height: 50px;
            border: 2px dashed #bdc3c7;
            border-radius: 6px;
            padding: 10px;
            transition: all 0.2s;
        }
        
        .drop-zone.active {
            border-color: #3498db;
            background-color: #e3f2fd;
        }
        
        .action-btn {
            padding: 6px 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            margin: 2px;
        }
        
        .action-btn:hover {
            background-color: #2980b9;
        }
        
        .action-btn.cancel {
            background-color: #e74c3c;
        }
        
        .action-btn.cancel:hover {
            background-color: #c0392b;
        }
        
        .action-btn.add {
            background-color: #2ecc71;
        }
        
        .action-btn.add:hover {
            background-color: #27ae60;
        }
        
        .action-btn.sync {
            background-color: #9b59b6;
        }
        
        .action-btn.sync:hover {
            background-color: #8e44ad;
        }
        
        .action-btn.delete {
            background-color: #e67e22;
        }
        
        .action-btn.delete:hover {
            background-color: #d35400;
        }
        
        .action-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .action-btn:disabled:hover {
            background-color: #95a5a6;
        }
        
        .empty-row {
            color: #95a5a6;
            font-style: italic;
        }
        
        .instructions {
            background-color: #e8f4fd;
            border-left: 6px solid #3498db;
            padding: 25px;
            margin-top: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .instructions h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions h3::before {
            content: "ğŸ’¡";
            font-size: 24px;
        }
        
        .instructions ul {
            padding-left: 25px;
            margin-bottom: 15px;
        }
        
        .instructions li {
            margin-bottom: 12px;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .warning-note {
            background-color: #fff8e1;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-weight: bold;
            color: #e67e22;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .sync-status {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .time-info {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .user-row.other-user {
            background-color: #f8f9fa;
        }
        
        .user-row.other-user input {
            background-color: #f1f2f6;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .instructions {
                padding: 20px;
            }
            
            .instructions h3 {
                font-size: 20px;
            }
            
            .instructions li {
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>è®ºæ–‡é€‰æ‹©ç³»ç»Ÿ - å¤šè®¾å¤‡åŒæ­¥ç‰ˆ</h1>
        <p>è¯·ä»å³ä¾§æ‹–æ‹½è®ºæ–‡æ ‡é¢˜åˆ°å·¦ä¾§è¡¨æ ¼ä¸­å¯¹åº”çš„ç»„å· - æ•°æ®åœ¨æ‰€æœ‰è®¾å¤‡é—´åŒæ­¥</p>
        <div class="sync-status" id="syncStatus">æ­£åœ¨åŒæ­¥æ•°æ®...</div>
        <div class="time-info" id="timeInfo"></div>
    </div>
    
    <div class="container">
        <div class="user-table-container">
            <h2 class="section-title">
                ç”¨æˆ·é€‰æ‹©è¡¨
                <div>
                    <button class="action-btn sync" id="syncBtn">æ‰‹åŠ¨åŒæ­¥</button>
                    <button class="action-btn add" id="addGroupBtn">å¢åŠ æˆ‘çš„ç»„åˆ«</button>
                </div>
            </h2>
            <table id="userTable">
                <thead>
                    <tr>
                        <th width="25%">ç»„å·</th>
                        <th width="55%">è®ºæ–‡å</th>
                        <th width="20%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- è¡¨æ ¼è¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        
        <div class="paper-list-container">
            <h2 class="section-title">å¯é€‰è®ºæ–‡åˆ—è¡¨</h2>
            <div id="paperList">
                <!-- è®ºæ–‡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <div class="instructions">
        <h3>é‡è¦ä½¿ç”¨è¯´æ˜</h3>
        <ul>
            <li><strong>åœ¨å·¦ä¾§è¡¨æ ¼ä¸­è¾“å…¥æ‚¨çš„ç»„å·</strong> - è¯·ç¡®ä¿ç»„å·å‡†ç¡®æ— è¯¯</li>
            <li><strong>ä»å³ä¾§åˆ—è¡¨ä¸­æ‹–æ‹½è®ºæ–‡æ ‡é¢˜åˆ°å·¦ä¾§è¡¨æ ¼çš„"è®ºæ–‡å"åˆ—</strong> - æ¯ç¯‡è®ºæ–‡åªèƒ½è¢«ä¸€ä¸ªç”¨æˆ·é€‰æ‹©</li>
            <li><strong>æƒé™è¯´æ˜</strong>ï¼šæ‚¨åªèƒ½ä¿®æ”¹è‡ªå·±ç»„çš„è¡Œï¼Œå…¶ä»–ç”¨æˆ·çš„é€‰æ‹©åªèƒ½æŸ¥çœ‹</li>
            <li><strong>åˆ é™¤æ“ä½œ</strong>ï¼šæ‚¨åªèƒ½åˆ é™¤è‡ªå·±çš„ç»„ï¼Œåˆ é™¤æ—¶ä¼šåŒæ—¶æ¸…é™¤ç»„å·å’Œè®ºæ–‡é€‰æ‹©</li>
            <li><strong>æ—¶é—´é™åˆ¶</strong>ï¼šé€‰æ‹©è®ºæ–‡å<strong>48å°æ—¶å†…</strong>å¯ä»¥æ”¾å¼ƒé€‰æ‹©ï¼Œè¶…è¿‡æ—¶é—´åå°†æ— æ³•ä¿®æ”¹</li>
            <li><strong>è‡ªåŠ¨åŒæ­¥</strong>ï¼šæ•°æ®ä¼šåœ¨æ‰€æœ‰è®¾å¤‡é—´è‡ªåŠ¨åŒæ­¥ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å…¶ä»–ç”¨æˆ·çš„å®æ—¶æ“ä½œ</li>
            <li><strong>æ‰‹åŠ¨åŒæ­¥</strong>ï¼šç‚¹å‡»"æ‰‹åŠ¨åŒæ­¥"æŒ‰é’®å¯ä»¥ç«‹å³åˆ·æ–°æ•°æ®</li>
        </ul>
        <div class="warning-note">
            âš ï¸ æ³¨æ„ï¼šè¯·è°¨æ…æ“ä½œï¼Œåˆ é™¤è‡ªå·±çš„ç»„åˆ«åæ— æ³•æ¢å¤ï¼
        </div>
    </div>

    <script>
        // è®ºæ–‡æ•°æ®
        const papers = [
            "åŸºäºæ·±åº¦å­¦ä¹ çš„å›¾åƒè¯†åˆ«æŠ€æœ¯ç ”ç©¶",
            "åŒºå—é“¾æŠ€æœ¯åœ¨ä¾›åº”é“¾é‡‘èä¸­çš„åº”ç”¨",
            "äººå·¥æ™ºèƒ½åœ¨åŒ»ç–—è¯Šæ–­ä¸­çš„æœ€æ–°è¿›å±•",
            "5Gé€šä¿¡ç½‘ç»œçš„å®‰å…¨ä¸éšç§ä¿æŠ¤",
            "å¤§æ•°æ®åˆ†æåœ¨å•†ä¸šæ™ºèƒ½ä¸­çš„åº”ç”¨",
            "ç‰©è”ç½‘æ™ºèƒ½å®¶å±…ç³»ç»Ÿè®¾è®¡ä¸å®ç°",
            "äº‘è®¡ç®—ç¯å¢ƒä¸‹çš„èµ„æºè°ƒåº¦ä¼˜åŒ–",
            "è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„æƒ…æ„Ÿåˆ†æç ”ç©¶",
            "è®¡ç®—æœºè§†è§‰åœ¨è‡ªåŠ¨é©¾é©¶ä¸­çš„åº”ç”¨",
            "è¾¹ç¼˜è®¡ç®—ä¸ç‰©è”ç½‘çš„èåˆç ”ç©¶",
            "æ™ºèƒ½æ¨èç³»ç»Ÿçš„ç®—æ³•ä¼˜åŒ–",
            "è™šæ‹Ÿç°å®ä¸å¢å¼ºç°å®æŠ€æœ¯æ¯”è¾ƒç ”ç©¶",
            "é‡å­è®¡ç®—çš„å‘å±•ç°çŠ¶ä¸å‰æ™¯åˆ†æ"
        ];

        // ä½¿ç”¨Google Apps Scriptä½œä¸ºåç«¯
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwFxD_LpUc2aqg4008HufowOM43J9ThOv3tM2iVolA7c0Utk1lCOqcFEcq63-4wRyDQ/exec'; // éœ€è¦æ›¿æ¢ä¸ºæ‚¨çš„Google Apps Script URL

        // ç”¨æˆ·æ ‡è¯†ï¼ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¥æ ‡è¯†å½“å‰ç”¨æˆ·ï¼‰
        let currentUserGroupId = localStorage.getItem('currentUserGroupId') || '';
        let selectionTimestamp = null;
        let users = [];

        // ä»æœåŠ¡å™¨åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=get`);
                const data = await response.json();
                if (data && data.users) {
                    users = data.users;
                    selectionTimestamp = data.timestamp;
                    updateSyncStatus('æ•°æ®åŒæ­¥æˆåŠŸ', 'success');
                    updateTimeInfo();
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                updateSyncStatus('åŒæ­¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', 'warning');
            }
        }

        // ä¿å­˜æ•°æ®åˆ°æœåŠ¡å™¨
        async function saveData(isNewSelection = false) {
            try {
                const timestamp = isNewSelection ? new Date().toISOString() : selectionTimestamp;
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save',
                        users: users,
                        timestamp: timestamp
                    })
                });
                
                if (response.ok) {
                    if (isNewSelection) {
                        selectionTimestamp = timestamp;
                    }
                    updateSyncStatus('æ•°æ®å·²åŒæ­¥', 'success');
                    updateTimeInfo();
                } else {
                    throw new Error('æœåŠ¡å™¨ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                updateSyncStatus('åŒæ­¥å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'deleteUser',
                        userId: userId
                    })
                });
                
                if (response.ok) {
                    await loadData();
                    renderUserTable();
                    renderPaperList();
                    updateSyncStatus('ç»„åˆ«å·²åˆ é™¤', 'success');
                }
            } catch (error) {
                console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                updateSyncStatus('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // æ£€æŸ¥æ˜¯å¦è¶…è¿‡48å°æ—¶
        function isWithin48Hours() {
            if (!selectionTimestamp) return true;
            const selectionTime = new Date(selectionTimestamp);
            const currentTime = new Date();
            const diffHours = (currentTime - selectionTime) / (1000 * 60 * 60);
            return diffHours <= 48;
        }

        // æ›´æ–°æ—¶é—´ä¿¡æ¯æ˜¾ç¤º
        function updateTimeInfo() {
            const timeInfo = document.getElementById('timeInfo');
            if (!selectionTimestamp) {
                timeInfo.textContent = '';
                return;
            }
            
            const selectionTime = new Date(selectionTimestamp);
            const currentTime = new Date();
            const diffHours = (currentTime - selectionTime) / (1000 * 60 * 60);
            const remainingHours = Math.max(0, 48 - diffHours);
            
            if (remainingHours > 0) {
                timeInfo.textContent = `è·ç¦»æ”¾å¼ƒé€‰æ‹©æˆªæ­¢æ—¶é—´è¿˜æœ‰: ${remainingHours.toFixed(1)} å°æ—¶`;
                timeInfo.style.color = '#27ae60';
            } else {
                timeInfo.textContent = 'æ”¾å¼ƒé€‰æ‹©æ—¶é—´å·²è¿‡ï¼Œæ— æ³•å†ä¿®æ”¹é€‰æ‹©';
                timeInfo.style.color = '#e74c3c';
            }
        }

        // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
        function updateSyncStatus(message, type = 'info') {
            const statusElement = document.getElementById('syncStatus');
            statusElement.textContent = message;
            
            statusElement.style.color = 
                type === 'success' ? '#27ae60' :
                type === 'warning' ? '#f39c12' :
                type === 'error' ? '#e74c3c' : '#7f8c8d';
        }

        // è·å–ä¸‹ä¸€ä¸ªå¯ç”¨çš„ç”¨æˆ·ID
        function getNextUserId() {
            return users.length > 0 ? Math.max(...users.map(user => user.id)) + 1 : 1;
        }

        // åˆå§‹åŒ–å‡½æ•°
        async function init() {
            await loadData();
            renderUserTable();
            renderPaperList();
            setupEventListeners();
            
            // è®¾ç½®è‡ªåŠ¨åŒæ­¥ï¼ˆæ¯10ç§’ï¼‰
            setInterval(async () => {
                await loadData();
                renderUserTable();
                renderPaperList();
            }, 10000);
        }

        // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
        function renderUserTable() {
            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = '';
            
            // å…ˆæ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„ç»„ï¼ˆå¦‚æœæœ‰ï¼‰
            const currentUser = users.find(user => user.groupId === currentUserGroupId);
            
            users.forEach((user) => {
                const tr = document.createElement('tr');
                const isCurrentUser = user.groupId === currentUserGroupId;
                
                if (!isCurrentUser) {
                    tr.classList.add('other-user');
                }
                
                // ç»„å·å•å…ƒæ ¼
                const groupTd = document.createElement('td');
                if (isCurrentUser) {
                    const groupInput = document.createElement('input');
                    groupInput.type = 'text';
                    groupInput.value = user.groupId;
                    groupInput.placeholder = 'è¯·è¾“å…¥ç»„å·';
                    groupInput.dataset.userId = user.id;
                    groupInput.addEventListener('change', handleGroupIdChange);
                    groupTd.appendChild(groupInput);
                } else {
                    groupTd.textContent = user.groupId || 'æœªè®¾ç½®ç»„å·';
                }
                
                // è®ºæ–‡åå•å…ƒæ ¼
                const paperTd = document.createElement('td');
                paperTd.className = 'drop-zone';
                paperTd.dataset.userId = user.id;
                
                if (user.paper) {
                    const paperDiv = document.createElement('div');
                    paperDiv.textContent = user.paper;
                    paperDiv.className = 'paper-item assigned';
                    paperTd.appendChild(paperDiv);
                } else if (isCurrentUser) {
                    paperTd.textContent = 'æ‹–æ”¾è®ºæ–‡åˆ°è¿™é‡Œ';
                    paperTd.classList.add('empty-row');
                } else {
                    paperTd.textContent = 'æœªé€‰æ‹©è®ºæ–‡';
                    paperTd.classList.add('empty-row');
                }
                
                // æ“ä½œå•å…ƒæ ¼
                const actionTd = document.createElement('td');
                if (isCurrentUser) {
                    if (user.paper) {
                        const cancelBtn = document.createElement('button');
                        cancelBtn.textContent = 'æ”¾å¼ƒé€‰æ‹©';
                        cancelBtn.className = 'action-btn cancel';
                        cancelBtn.dataset.userId = user.id;
                        cancelBtn.disabled = !isWithin48Hours();
                        cancelBtn.addEventListener('click', handleCancelSelection);
                        actionTd.appendChild(cancelBtn);
                    }
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'åˆ é™¤æˆ‘çš„ç»„';
                    deleteBtn.className = 'action-btn delete';
                    deleteBtn.dataset.userId = user.id;
                    deleteBtn.addEventListener('click', handleDeleteUser);
                    actionTd.appendChild(deleteBtn);
                } else {
                    actionTd.textContent = '-';
                }
                
                tr.appendChild(groupTd);
                tr.appendChild(paperTd);
                tr.appendChild(actionTd);
                tbody.appendChild(tr);
            });
            
            // è®¾ç½®æ‹–æ”¾äº‹ä»¶
            setupDropZones();
        }

        // æ¸²æŸ“è®ºæ–‡åˆ—è¡¨
        function renderPaperList() {
            const paperList = document.getElementById('paperList');
            paperList.innerHTML = '';
            
            papers.forEach((paper, index) => {
                // æ£€æŸ¥è®ºæ–‡æ˜¯å¦å·²è¢«é€‰æ‹©
                const isAssigned = users.some(user => user.paper === paper);
                
                const paperDiv = document.createElement('div');
                paperDiv.textContent = paper;
                paperDiv.className = 'paper-item';
                paperDiv.dataset.paperIndex = index;
                paperDiv.draggable = !isAssigned;
                
                if (isAssigned) {
                    paperDiv.classList.add('assigned');
                }
                
                paperList.appendChild(paperDiv);
            });
            
            // è®¾ç½®æ‹–æ‹½äº‹ä»¶
            setupDragEvents();
        }

        // è®¾ç½®æ‹–æ‹½äº‹ä»¶
        function setupDragEvents() {
            const paperItems = document.querySelectorAll('.paper-item');
            
            paperItems.forEach(item => {
                if (item.draggable) {
                    item.addEventListener('dragstart', handleDragStart);
                }
            });
        }

        // è®¾ç½®æ”¾ç½®åŒºåŸŸäº‹ä»¶
        function setupDropZones() {
            const dropZones = document.querySelectorAll('.drop-zone');
            
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragenter', handleDragEnter);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('drop', handleDrop);
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å…¨å±€æ‹–æ”¾äº‹ä»¶
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            document.addEventListener('drop', function(e) {
                e.preventDefault();
            });
            
            // æ·»åŠ ç»„åˆ«æŒ‰é’®
            document.getElementById('addGroupBtn').addEventListener('click', handleAddGroup);
            
            // æ‰‹åŠ¨åŒæ­¥æŒ‰é’®
            document.getElementById('syncBtn').addEventListener('click', handleManualSync);
        }

        // å¤„ç†æ‰‹åŠ¨åŒæ­¥
        async function handleManualSync() {
            updateSyncStatus('æ­£åœ¨åŒæ­¥...', 'info');
            await loadData();
            renderUserTable();
            renderPaperList();
        }

        // å¤„ç†æ‹–æ‹½å¼€å§‹
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.textContent);
            e.target.classList.add('dragging');
        }

        // å¤„ç†æ‹–æ‹½æ‚¬åœ
        function handleDragOver(e) {
            e.preventDefault();
        }

        // å¤„ç†æ‹–æ‹½è¿›å…¥
        function handleDragEnter(e) {
            e.preventDefault();
            e.target.classList.add('active');
        }

        // å¤„ç†æ‹–æ‹½ç¦»å¼€
        function handleDragLeave(e) {
            e.target.classList.remove('active');
        }

        // å¤„ç†æ”¾ç½®
        async function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('active');
            
            const paperTitle = e.dataTransfer.getData('text/plain');
            const userId = parseInt(e.target.dataset.userId);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·
            const user = users.find(u => u.id === userId);
            if (!user || user.groupId !== currentUserGroupId) {
                alert('æ‚¨åªèƒ½ä¸ºè‡ªå·±çš„ç»„é€‰æ‹©è®ºæ–‡ï¼');
                return;
            }
            
            // æ£€æŸ¥è®ºæ–‡æ˜¯å¦å·²è¢«é€‰æ‹©
            const isPaperAssigned = users.some(user => user.paper === paperTitle);
            
            if (isPaperAssigned) {
                alert('è¯¥è®ºæ–‡å·²è¢«å…¶ä»–ç”¨æˆ·é€‰æ‹©ï¼Œè¯·é€‰æ‹©å…¶ä»–è®ºæ–‡ã€‚');
                return;
            }
            
            // æ›´æ–°ç”¨æˆ·æ•°æ®
            const userIndex = users.findIndex(user => user.id === userId);
            if (userIndex !== -1) {
                users[userIndex].paper = paperTitle;
                const isNewSelection = !selectionTimestamp;
                await saveData(isNewSelection);
                renderUserTable();
                renderPaperList();
            }
            
            // ç§»é™¤æ‹–æ‹½å…ƒç´ çš„æ ·å¼
            const draggingItem = document.querySelector('.paper-item.dragging');
            if (draggingItem) {
                draggingItem.classList.remove('dragging');
            }
        }

        // å¤„ç†ç»„å·å˜æ›´
        async function handleGroupIdChange(e) {
            const userId = parseInt(e.target.dataset.userId);
            const groupId = e.target.value;
            
            const userIndex = users.findIndex(user => user.id === userId);
            if (userIndex !== -1) {
                const oldGroupId = users[userIndex].groupId;
                users[userIndex].groupId = groupId;
                currentUserGroupId = groupId;
                localStorage.setItem('currentUserGroupId', groupId);
                await saveData();
                
                // å¦‚æœç»„å·æ”¹å˜ï¼Œé‡æ–°æ¸²æŸ“è¡¨æ ¼
                if (oldGroupId !== groupId) {
                    renderUserTable();
                }
            }
        }

        // å¤„ç†æ”¾å¼ƒé€‰æ‹©
        async function handleCancelSelection(e) {
            if (!isWithin48Hours()) {
                alert('å·²è¶…è¿‡48å°æ—¶ï¼Œæ— æ³•æ”¾å¼ƒé€‰æ‹©ï¼');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ”¾å¼ƒå½“å‰é€‰æ‹©çš„è®ºæ–‡å—ï¼Ÿ')) {
                return;
            }
            
            const userId = parseInt(e.target.dataset.userId);
            
            const userIndex = users.findIndex(user => user.id === userId);
            if (userIndex !== -1) {
                users[userIndex].paper = null;
                await saveData();
                renderUserTable();
                renderPaperList();
            }
        }

        // å¤„ç†åˆ é™¤ç”¨æˆ·
        async function handleDeleteUser(e) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ‚¨çš„ç»„å—ï¼Ÿè¿™å°†æ¸…é™¤æ‚¨çš„ç»„å·å’Œè®ºæ–‡é€‰æ‹©ï¼')) {
                return;
            }
            
            const userId = parseInt(e.target.dataset.userId);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·
            const user = users.find(u => u.id === userId);
            if (user && user.groupId === currentUserGroupId) {
                await deleteUser(userId);
                currentUserGroupId = '';
                localStorage.removeItem('currentUserGroupId');
            }
        }

        // å¤„ç†æ·»åŠ ç»„åˆ«
        async function handleAddGroup() {
            if (currentUserGroupId && users.some(user => user.groupId === currentUserGroupId)) {
                alert('æ‚¨å·²ç»æœ‰ä¸€ä¸ªç»„äº†ï¼æ¯ä¸ªç”¨æˆ·åªèƒ½æœ‰ä¸€ä¸ªç»„ã€‚');
                return;
            }
            
            const newGroupId = prompt('è¯·è¾“å…¥æ‚¨çš„ç»„å·ï¼š');
            if (!newGroupId) {
                return;
            }
            
            // æ£€æŸ¥ç»„å·æ˜¯å¦å·²å­˜åœ¨
            if (users.some(user => user.groupId === newGroupId)) {
                alert('è¯¥ç»„å·å·²è¢«ä½¿ç”¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ç»„å·ï¼');
                return;
            }
            
            const newUserId = getNextUserId();
            users.push({ id: newUserId, groupId: newGroupId, paper: null });
            currentUserGroupId = newGroupId;
            localStorage.setItem('currentUserGroupId', newGroupId);
            await saveData();
            renderUserTable();
            renderPaperList();
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
